<?php
/**
 * Magedelight
 * Copyright (C) 2019 Magedelight <info@magedelight.com>
 *
 * @category Magedelight
 * @package Magedelight_Sales
 * @copyright Copyright (c) 2019 Mage Delight (http://www.magedelight.com/)
 * @license http://opensource.org/licenses/gpl-3.0.html GNU General Public License,version 3 (GPL-3.0)
 * @author Magedelight <info@magedelight.com>
 */
?>
<?php /** #var $block Magedelight\Vendor\Block\Orde\Cancelgrid */ ?>
<?php
$gridsession = $block->getGridSession();
$orders_cancel = $gridsession['grid_session']['orders_cancel'];
$_orders = $block->getCollection();
$helper = $this->helper('Magedelight\Vendor\Helper\Data');
$tab = $block->getTab();
?>
<form action="<?= $block->getSubmitUrl() ?>" method="get" id="vendor-cancelled-order-search" name="vendor_complete_order_search">
    <div class="row cancel-order-list">
        <div class="row-gutter toolbar-wrapper  mb10">
            <div class="col-xs-4">
                <input type="hidden" name="tab" value="<?= $tab; ?>">
                <input type="hidden" name="sfrm" value="cancelled">
                <input id="sort-order" type="hidden" name="sort_order" value="<?= $orders_cancel['sort_order'] ?>">
                <input id="sort-direction" type="hidden" name="dir" value="<?= $orders_cancel['dir'] ?>">
                <div class="block block-search">
                    <div class="content">
                        <div class="field search-catalog">
                            <div class="control">
                                <input placeholder="<?= __('Search...') ?>" type="text" value="<?php
                                if ($orders_cancel['q']) { ?>
                                    <?= $orders_cancel['q']; ?>
                                <?php } else { ?>
                                    <?= $helper->searchText(); ?>
                                <?php }
                                ?>" name="q" id="search-order-input-cancelorder" class="input-text vendor search-order-input">
                            </div>
                            <div class="actions">
                                <div class="vendor primary"><button type="submit" class="vendor action login primary"><span><?= __('Search') ?></span></button></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-xs-8">
                <div class="row">
                    <div class="col-xs-3 pt10">
                        <a rel="new" href="javascript:void(0)" class="action-reset search"><?= __('Reset') ?></a>
                    </div>
                     <div class="col-xs-9">
                        <div class="toolbar-filter-wrapper">
                            <div class="data-grid-filters-actions-wrap">
                                <div class="data-grid-filters-action-wrap">
                                    <a class="action primary export" class="action primary export" href="<?= $block->getUrl(
                                        '*/*/exportPost',
                                        ['_current' => true, 'sfrm' => 'cancelled']
                                    ) ?>"><?= __('Export') ?>        </a>
                                </div>
                            </div>
                            <div class="data-grid-filters-actions-wrap">
                                <div class="data-grid-filters-action-wrap">
                                    <span class="clear-filters mr10"><a rel="new" href="javascript:void(0)" class="action action-reset filter"><?= __('Clear') ?></a></span>
                                    <button class="action secondary action-default _active" type="button" data-action="grid-filter-expand" title="Filters">
                                        <span><?= __('Filters') ?></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>



        </div>
    </div>
    <div class="filter-wrapper" style="display: none;">
        <fieldset class="row fieldset">
            <div class="row-gutter filter-row">
                <div class="col-md-6 col-lg-3 filter-section">
                    <fieldset class="fieldset" id="purchased_date_range">
                        <legend class="legend">
                            <span class=""><?= __('Purchased Date') ?></span>
                        </legend>
                        <div class="field">
                            <label class="label" for="purchased_date_from">
                                <span><?= __('from') ?></span>
                            </label>
                            <div class="control date-control date-field-container">
                                <input class="input-text"
                                       type="text"
                                       name="pdate_from"
                                       placeholder="MM/DD/YYYY"
                                       id="purchased_date_from"
                                       value="<?php
                                        if ($orders_cancel['pdate_from']) { ?>
                                            <?= $orders_cancel['pdate_from']; ?>
                                        <?php } else { ?>
                                            <?= $this->getRequest()->getParam('purchaseddate')['from']; ?>
                                        <?php }
                                        ?>">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label" for="purchased_date_to">
                                <span><?= __('to') ?></span>
                            </label>
                            <div class="control date-control date-field-container">
                                <input class="input-text" 
                                       type="text"  
                                       name="pdate_to"  
                                       placeholder="MM/DD/YYYY"
                                       id="purchased_date_to" 
                                       value="<?php
                                        if ($orders_cancel['pdate_to']) { ?>
                                            <?= $orders_cancel['pdate_to']; ?>
                                        <?php } else { ?>
                                            <?= $this->getRequest()->getParam('purchaseddate')['to']; ?>
                                        <?php }
                                        ?>">
                            </div>
                        </div>

                    </fieldset>
                </div>
                <div class="col-md-6 col-lg-3 filter-section">
                    <fieldset class="fieldset" >
                        <legend class="legend">
                            <span class=""><?= __('Grand Total') ?></span>
                        </legend>
                        <div class="field">
                            <label class="label" for="grndt_from">
                                <span><?= __('from') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" placeholder="<?= __('Min'); ?>" name="grndt_from" id="grndt_from" value="<?php
                                if ($orders_cancel['grndt_from']) { ?>
                                    <?= $orders_cancel['grndt_from']; ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label" for="grndt_to">
                                <span><?= __('to') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" placeholder="<?= __('Max'); ?>" name="grndt_to" id="grndt_from" value="<?php
                                if ($orders_cancel['grndt_to']) { ?>
                                    <?= $orders_cancel['grndt_to']; ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-6 col-lg-3 filter-section">
                    <fieldset class="fieldset" >
                        <legend class="legend">
                            <span class=""><?= __('Cancellation Fee') ?></span>
                        </legend> 
                        <div class="field">
                            <label class="label" for="cf-from">
                                <span><?= __('from') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" placeholder="<?= __('Min'); ?>" name="cf_from" id="cf-from" value="<?php
                                if ($orders_cancel['cf_from']) { ?>
                                    <?= $orders_cancel['cf_from']; ?>
                                <?php } else { ?>
                                           <?= $this->getRequest()->getParam('cf')['from']; ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                        <div class="field">
                            <label class="label" for="cf-to">
                                <span><?= __('to') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" placeholder="<?= __('Max'); ?>" name="cf_to" id="cf-to" value="<?php
                                if ($orders_cancel['cf_to']) { ?>
                                    <?= $orders_cancel['cf_to']; ?>
                                <?php } else { ?>
                                    <?= $this->getRequest()->getParam('cf')['to']; ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="row-gutter filter-row">
                <div class="col-md-4 filter-section">
                    <fieldset class="fieldset field-full-width">
                        <div class="field">
                            <label class="label"  for="increment_id">
                                <span><?= __('ID'); ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" name="increment_id" placeholder="ID" id="increment_id" value="<?php
                                if ($orders_cancel['increment_id']) { ?>
                                    <?= $orders_cancel['increment_id']; ?>
                                <?php } else { ?>
                                    <?= $this->getRequest()->getParam('increment_id'); ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-4 filter-section">
                    <fieldset class="fieldset field-full-width">
                        <div class="field">
                            <label class="label"  for="bill_to_name">
                                <span><?= __('Bill To Name') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" name="bill_to_name" placeholder="<?= __('Bill To Name');?>" id="bill_to_name" value="<?php
                                if ($orders_cancel['bill_to_name']) { ?>
                                    <?= $orders_cancel['bill_to_name']; ?>
                                <?php } else { ?>
                                    <?= $this->getRequest()->getParam('bill_to_name'); ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                    </fieldset>
                </div>
                <div class="col-md-4 filter-section">
                    <fieldset class="fieldset field-full-width">
                        <div class="field">
                            <label class="label"  for="ship_to_name">
                                <span><?= __('Ship To Name') ?></span>
                            </label>
                            <div class="control">
                                <input class="input-text" type="text" name="ship_to_name" placeholder="<?= __('Ship To Name') ?>" id="ship_to_name" value="<?php
                                if ($orders_cancel['ship_to_name']) { ?>
                                    <?= $orders_cancel['ship_to_name']; ?>
                                <?php } else { ?>
                                    <?= $this->getRequest()->getParam('ship_to_name'); ?>
                                <?php }
                                ?>">
                            </div>
                        </div>
                    </fieldset>
                </div>
            </div>
        </fieldset>
        <div class="row">
        <div class="row-gutter">
            <div class="filters-footer col-md-12">
                <div class="action-toolbar main-actions">
                    <button class="action primary grid-filter-cancel cancel" type="reset" data-action="grid-filter-cancel" >
                        <span><?= __('Cancel') ?></span>
                    </button>
                    <button class="action primary" type="submit" data-action="grid-filter-apply" >
                        <span><?= __('Apply') ?></span>
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>
    <input type="hidden" name="session-clear-ordercancel" id="session-clear-ordercancel" value="0"/>

</form>
<?php if ($_orders && count($_orders)) : ?>
    <div class="table-wrapper orders-history">

        <table class="data table table-order-items history" id="cancelled-orders-table">

            <caption class="table-caption"><?= __('Orders') ?></caption>
            <thead>
                <tr>
                    <th scope="col" sortorder="rvo_vendor_order_id" class="col data-grid-id-cell id sortable"><?= __('ID #') ?></th>
                    <th scope="col" sortorder="rvo_created_at" class="col data-grid-date-cell date sortable"><?= __('Purchase Date') ?></th>
                    <th scope="col" sortorder="bill_to_name" class="col col-bill-to-name billing sortable"><?= __('Bill To Name') ?></th>
                    <th scope="col" sortorder="ship_to_name" class="col col-ship-to-name shipping sortable"><?= __('Ship To Name') ?></th>
                    <th scope="col" sortorder="rvp_cancellation_fee" class="col col-cancellation-fee cancellation-fee sortable"><?= __('Cancellation Fee') ?></th>
                    <th scope="col" sortorder="rvo_grand_total" class="col col-grand-total total sortable"><?= __('Grand Total') ?></th>
                    <th scope="col" class="col actions"><?= __('Action') ?></th>
                </tr>
            </thead>
            <tbody>
                <?php foreach ($_orders as $_order) : ?>
                    <tr>
                        <td data-th="<?= $block->escapeHtml(__('ID #')) ?>" class="col data-grid-id-cell">
                            <table>
                                <tr>
                                    <td align="center">
                                        <strong>
                                            <?= $_order->getRvoIncrementId() ?>
                                        </strong>
                                        <label style="display: inherit;"><?=
                                         __('Cancelled By %1', $block->getOrderCancelledBy($_order->getCancelledBy()));
                                        ?></label>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <?= $block->getOrderSummarizedHtml($_order); ?>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td data-th="<?= $block->escapeHtml(__('Purchase Date')) ?>" class="col data-grid-date-cell"><?= $block->getCurrentLocaleDate($_order->getRvoCreatedAt()) ?></td>
                        <td data-th="<?= $block->escapeHtml(__('Bill To Name')) ?>" class="col data-grid-bill-to-name-cell billing"><?= $_order->getBillToName() ?></td>
                        <td data-th="<?= $block->escapeHtml(__('Ship To Name')) ?>" class="col data-grid-ship-to-name-cell shipping"><?= $_order->getShipToName() ?></td>
                        <td data-th="<?= $block->escapeHtml(__('Cancellation Fee')) ?>" class="col data-grid-price-cell"><?= $this->helper('Magento\Framework\Pricing\Helper\Data')->currency($_order->getRvpCancellationFee()) ?></td>
                        <td data-th="<?= $block->escapeHtml(__('Grand Total')) ?>" class="col data-grid-price-cell"><?= $this->helper('Magento\Framework\Pricing\Helper\Data')->currency($_order->getRvoGrandTotal()) ?></td>
                        <td data-th="<?= $block->escapeHtml(__('Actions')) ?>" class="col data-grid-actions-cell">
                            <a href="<?= $block->getViewUrl($_order) ?>" class="action view">
                                <span><?= __('View') ?></span>
                            </a>                            
                        </td>
                    </tr>
                <?php endforeach; ?>

            </tbody>
        </table>
    </div>
    <?php if ($block->getPagerHtml()) : ?>
        <div class="order-products-toolbar toolbar bottom"><?= $block->getPagerHtml(); ?></div>
    <?php endif ?>
    <script type="text/javascript">
        require([
            'jquery'
                    , 'mage/calendar', /* Calender widget */
        ], function ($) {

            $(document).ready(function () {

                /*
                 * Sorting feature
                 */
                $currentSortOrder = $('#sort-order').val();
                $currentSortDir = $('#sort-direction').val();

                if ($currentSortOrder != null && $currentSortOrder != '') {
                    $sortDirClass = ($currentSortDir == 'DESC') ? 'descend' : 'ascend';
                    $('#cancelled-orders-table th[sortorder="' + $currentSortOrder + '"]').addClass($sortDirClass);
                }
                $sortDir = 'ASC';

                $('#cancelled-orders-table .sortable').click(function ($e) {
                    $sortOrder = $(this).attr('sortorder');
                    if ($currentSortOrder == $sortOrder) {
                        $sortDir = ($currentSortDir == 'DESC') ? 'ASC' : 'DESC';
                    }
                    $('#sort-order').val($sortOrder); /*for post */
                    $('#sort-direction').val($sortDir); /*for post */
                    $('#vendor-cancelled-order-search').submit();
                });





            });


        });
    </script>       
<?php else : ?>    
    <script type="text/javascript">
        require(['jquery'], function ($) {
            $(document).ready(function () {
                /*  debugger; */
                $value = "false";
                $('input[type=text]').each(function () {
                    var text_value = $(this).val();
                    if (text_value != '')
                    {
                        $value = "true";
                    }

                })
                if (jQuery('#search-order-input-cancelorder')[0].value != "" || $value == "true") {
                    jQuery('#cancelorder-msg span').html('<?= __("Your search result could not find.")?>');
                    //jQuery('#empty-msg-neworder')[0].html("Your search result could not find"); 
                } else {
                    jQuery('#cancelorder-msg span').html("<?= __("We couldn't find any records.")?>");
                }

            });
        });
    </script>
    <div class="table-wrapper orders-history">
        <table class="data table table-order-items history" id="new-orders-table">
            <thead>
                <tr>
                    <th scope="col" sortorder="rvo_vendor_order_id" class="col id sortable"><?= __('ID #') ?></th>
                    <th scope="col" sortorder="rvo_created_at" class="col date sortable"><?= __('Purchase Date') ?></th>
                    <th scope="col" sortorder="bill_to_name" class="col billing sortable"><?= __('Bill To Name') ?></th>
                    <th scope="col" sortorder="ship_to_name" class="col shipping sortable"><?= __('Ship To Name') ?></th>
                    <th scope="col" sortorder="rvp_cancellation_fee" class="col cancellation-fee sortable"><?= __('Cancellation Fee') ?></th>
                    <th scope="col" sortorder="rvo_grand_total" class="col total sortable"><?= __('Grand Total') ?></th>
                    <th scope="col" class="col actions"><?= __('Action') ?></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td colspan="7">                        
                        <div id="cancelorder-msg" class="message info empty"><span></span></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>    
<?php endif; ?>
<script type="text/javascript">
    require([
        'jquery',
        'mage/calendar'
    ], function ($) {

        $(".action-default").click(function () {
            $(this).parents('.row').next('.filter-wrapper').toggle(500);
        });

        $(".grid-filter-cancel").click(function () {
            $(this).parents('.filter-wrapper').toggle(500);
        });

        $("button.grid-filter-clear-all").click(function ($e) {
            $form = $(this).parents('form');
            $(':input:not([type=hidden])', $form).val("");
            $($form).submit();
        });

        $("#purchased_date_range").dateRange({
            buttonText: "<?= __('Select Date') ?>",
            showOn: "button",
            from: {
                id: "purchased_date_from"
            },
            to: {
                id: "purchased_date_to"
            }
        });

        $(".action-reset").click(function () {
            $form = $(this).parents('form');
            if ($(this).hasClass('search')) {
                $parent = $('.block-search', $form);
            } else {
                $parent = $('.filter-wrapper', $form);
            }
            $(':input:not([type=hidden])', $parent).val("");
            jQuery('#session-clear-ordercancel').val(1);
            $($form).submit();
        });

    });
</script>
